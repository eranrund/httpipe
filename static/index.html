<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>httpi.pe</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
        <link href="bootstrap/css/darkstrap.min.css" rel="stylesheet" media="screen">
        <style>
        body {
            /* used for navbar - not needed for now padding-top: 60px; */
            padding-top: 10px;
        }

        .icon-ajax {
            background-image: url("img/ajax-dark.gif");
            background-position: 0 0;
            width: 16px;
            height: 16px;
            line-height: 16px;
        }

        .nav {
            margin-bottom: 0px;
        }

        .top-container .info {
            margin-bottom: 10px;
        }
        .top-container .sid {
            font-style: italic;
        }

        .magic-url {
            font-weight: bold;
        }

        /* TODO sucky selector, search-replace this */
        .request .accordion-heading .icon-refresh {
            border: 1px solid #2f2f2f;
        }
        .request .accordion-heading .icon-refresh:hover {
            border: 1px solid #eee;
            cursor: pointer;
        }
        </style>
    </head>
    <body>
        <!-- not needed for now <div class="navbar navbar-inverse navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="brand" href="#">httpi.pe</a>
                    <div class="nav-collapse collapse">
                        <ul class="nav">
                            <li class="active"><a href="#">Home</a></li>
                            <li><a href="#about">About</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div> -->

        <div class="navbar navbar-fixed-bottom">
            Copyright &copy; Eran Rundstein (<a href="mailto:eranrund@gmail.com">eranrund@gmail.com</a>)
        </div>

        <div class="container top-container">
            <div class="row">
                <div class="span3">
                    <h1>httpi.pe</h1>
                    <span class="sid">Loading...</span>
                </div>
                <div class="span9 info">
                    Make requests to <span class="magic-url"></span>. We will log it for you, but this is not the highlight of this service.<br/>
                    The real magic is that we let you redirect the request to an internal web server using a lightweight redirector running on your machine. <a href="https://github.com/eranrund/httpipe">Learn more...</a>
                </div>
            </div>
        </div>

        <div class="container" id="requests-container">
        </div>

        <!-- Templates -->
        <script type="text/template" id="request-template">
        <div id="<%= req.id %>" class="request row">
            <div class="span12">
                <div class="accordion" id="accordion-<%= req.id %>">
                    <div class="accordion-group">
                        <div class="accordion-heading">
                            <a class="accordion-toggle" style="float:left;" data-toggle="collapse" data-parent="#accordion-<%= req.id %>" href="#collapse-<%= req.id %>">
                                <i class="icon-thumbs-up" style="display:none;"></i>
                                <i class="icon-thumbs-down" style="display:none;"></i>
                                <i class="icon-ajax"></i>
                                <div class="status-text label">Waiting...</div>
                                <%= req.method %> <%= _.escape(req.url) %>
                            </a>
                            <div style="float:right; padding: 8px 15px;">
                                <%= moment.utc(req.started_at).local().format() %>
                                <a title="Replay request"><i class="icon-refresh"></i></a>
                            </div>
                            <div class="clearfix"></div>
                        </div>
                    <div id="collapse-<%= req.id %>" class="accordion-body collapse">
                    <div class="accordion-inner">
                        <ul class="nav nav-tabs">
                            <li class="active"><a href="#tab-<%= req.id %>-req" data-toggle="tab">Request</a>
                            <li><a href="#tab-<%= req.id %>-resp" data-toggle="tab">Response</a>
                        </ul>
                        <div class="tab-content">
                            <!-- request tab -->
                            <div class="tab-pane active" id="tab-<%= req.id %>-req">
                                <h4>Headers</h4>
                                <table class="req-headers table table-condensed">
                                    <tbody>
                                    <% _.each(req.headers, function(v, k) { %>
                                        <tr>
                                            <td><%= _.escape(k) %></td>
                                            <td><%= _.escape(v) %></td>
                                        </tr>
                                    <% }) %>
                                    </tbody>
                                </table>

                                <% if (req.data.length) { %>
                                    <h4>Body</h4>
                                    <div style="max-height: 200px; overflow-y: auto;">
                                        <pre><%= _.escape(req.data) %></pre>
                                    </div>
                                <% } %>
                            </div>

                            <!-- response tab -->
                            <div class="tab-pane tab-response" id="tab-<%= req.id %>-resp">
                                Waiting for response...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </script>

        <script type="text/template" id="response-template">
        <h4>Headers</h4>
        <table class="resp-headers table table-condensed">
            <tbody>
            <% _.each(resp.headers, function(v, k) { %>
                <tr>
                    <td><%= _.escape(k) %></td>
                    <td><%= _.escape(v) %></td>
                </tr>
            <% }) %>
            </tbody>
        </table>

        <h4>Body</h4>
        <div style="max-height: 200px; overflow-y: auto;">
            <pre><%= _.escape(resp.data) %></pre>
        </div>
        </script>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.2/jquery.min.js"></script>
        <script src="bootstrap/js/bootstrap.min.js"></script>
        <script src="js/underscore-min.js"></script>
        <script src="js/moment.min.js"></script>
        <script src="/__httpipe_socket.io/socket.io.js"></script>
        <script type="text/javascript">
///////////////////////////////////////////////////////////////////////////////
// Settings
///////////////////////////////////////////////////////////////////////////////

var HTTPIPE_SID_LEN = 10;


///////////////////////////////////////////////////////////////////////////////
// Settings
///////////////////////////////////////////////////////////////////////////////

var HttpipeFrontendApp = (function() {
    // Constructor
    function HttpipeFrontendApp() {
        var self = this;

        // Bind hash change event
        $(window).bind('hashchange', function(e) {
            window.location.reload();
        });

        // Init
        this.init();
    };

    // Init
    HttpipeFrontendApp.prototype.init = function() {
        var self = this;

        // See if we have a session id hash
        var sid = '';
        if (!window.location.hash || window.location.hash.length != (HTTPIPE_SID_LEN+1)) {
            // Generate a new id
            var charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            for (var i = 0; i < HTTPIPE_SID_LEN; ++i) {
                sid += charset.charAt(Math.floor(Math.random() * charset.length));
            }

            // Switch to the sid
            window.location.hash = sid;
            return;
        } else {
            sid = window.location.hash.substr(1);
        }

        // Store sid
        this.sid = sid;

        // Set info
        var url = 'http://' + this.sid + '.' + window.location.host + '/';
        $('.top-container .info .magic-url').html('<a href="'+url+'" target="_blank">'+url+'</a>');
        $('.top-container .sid').text(sid);

        console.log('Session id: '+sid);

        // Init templates
        this.request_template = _.template($('#request-template').html());
        this.response_template = _.template($('#response-template').html());

        // Init DOM events (buttons, etc)
        $('#requests-container').on('click', '.request .accordion-heading .icon-refresh', $.proxy(this.on_btn_req_replay, this));

        // Init socket.io
        var socket = io.connect(null, {
            resource: '__httpipe_socket.io',
        });
        this.socket = socket;

        socket.on('connect', function() {
            console.log('socket connected!', socket);
            socket.emit('room:join', sid);
        });

        socket.on('request', $.proxy(self.on_socket_request, self));
        socket.on('response', $.proxy(self.on_socket_response, self));
    };

    // socket.io event: request
    HttpipeFrontendApp.prototype.on_socket_request = function(req) {
        console.log('REQ', req);

        var $requests_container = $('#requests-container');

        var $el = $(this.request_template({ req: req }));
        $el.data('httpipe-req', req);
        $requests_container.prepend($el);
    };

    // socket.io event: response
    HttpipeFrontendApp.prototype.on_socket_response = function(req_id, resp) {
        console.log('RESP', req_id, resp);

        // Get container and template
        var $container = $('#requests-container').find('#'+req_id);
        if (!$container || !$container.length) {
            // TODO
            console.log('no request :(');
            return;
        }

        // Icon management
        $container.find('.accordion-toggle .icon-ajax').hide();
        if ((resp.status_code) >= 200 && (resp.status_code <= 299)) { // TODO
            $container.find('.accordion-toggle .icon-thumbs-up').show();
            $container.find('.accordion-heading .status-text').addClass('label-success');
        } else {
            $container.find('.accordion-toggle .icon-thumbs-down').show();
            $container.find('.accordion-heading .status-text').addClass('label-important');
        }

        // Status text
        $container.find('.accordion-heading .status-text').text(resp.status_code);

        // Response
        $container.find('.tab-response').html(this.response_template({ resp: resp }));
    };

    // DOM event: request replay button
    HttpipeFrontendApp.prototype.on_btn_req_replay = function(e) {
        e.stopPropagation();
        e.preventDefault();

        var req = $(e.target).parents('div.request').data('httpipe-req');
        console.log('replay', req);

        // Replay request
        this.socket.emit('replay_request', {
            method: req.method,
            url: req.url,
            headers: req.headers,
            data: req.data,
            sid: req.sid,
        });
    }


    return HttpipeFrontendApp;
})();


///////////////////////////////////////////////////////////////////////////////
// Init
///////////////////////////////////////////////////////////////////////////////

$(document).ready(function() {
    // Create app instance
    var app = new HttpipeFrontendApp();

    return;


    // html stuff
    var request_template = _.template($('#request-template').html());
    var response_template = _.template($('#response-template').html());
    var $requests_container = $('#requests-container');

    // socket.io
    var socket = io.connect(null, {resource: '__httpipe_socket.io'});
        socket.on('connect', function() {
            console.log('socket connected', socket);
        });

    socket.on('request', function(req) {
        console.log('REQ', req);
        var $el = $(request_template({
            req: req
        }));
        $el.data('httpipe-req', req);
        $requests_container.prepend($el);
    });

    socket.on('response', function(req_id, resp) {
        console.log('RESP', req_id, resp);

        // Get container
        var $container = $('#requests-container').find('#'+req_id);
        if (!$container || !$container.length) {
            // TODO
            console.log('no request :(');
            return;
        }

        // Icon management
        $container.find('.accordion-toggle .icon-ajax').hide();
        if ((resp.status_code) >= 200 && (resp.status_code <= 299)) { // TODO
            $container.find('.accordion-toggle .icon-thumbs-up').show();
        } else {
            $container.find('.accordion-toggle .icon-thumbs-down').show();
        }

        // Status text
        $container.find('.accordion-heading .status-text').text('[' + resp.status_code + ']');

        // Response
        $container.find('.tab-response').html(response_template({
            resp: resp
        }));
    });

    // buttons
    $requests_container.on('click', '.request .accordion-heading .icon-refresh', function(e) {
        e.stopPropagation();
        e.preventDefault();

        var req = $(this).parents('div.request').data('httpipe-req');
        console.log('replay', req);

        // Replay request
        socket.emit('replay_request', {
            method: req.method,
            url: req.url,
            headers: req.headers,
            data: req.data,
        });
    });
});
        </script>
    </body>
</html>
